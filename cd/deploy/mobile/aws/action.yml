##
# (c) 2021-2025
#     Cloud Ops Works LLC - https://cloudops.works/
#     Find us on:
#       GitHub: https://github.com/cloudopsworks
#       WebSite: https://cloudops.works
#     Distributed Under Apache v2.0 License
#
name: Deploy Mobile Application AWS Device Farm
author: cloudopsworks
description: Deploy Mobile Application to AWS Device Farm
inputs:
  source_path:
    description: 'The path to the source code'
    required: false
    default: 'source'
  blueprint_path:
    description: 'The path to the blueprint'
    required: false
    default: 'bp'
  token:
    description: 'The GitHub token'
    required: true
  platform_type:
    description: 'The mobile platform type'
    required: true
  aws_region:
    description: 'The AWS region'
    required: true
  aws_sts_role_arn:
    description: 'The AWS STS Role ARN'
    required: true
  aws_access_key_id:
    description: 'The AWS access key ID'
    required: true
  aws_secret_access_key:
    description: 'The AWS secret access key'
    required: true
  terraform_state_conf:
    description: 'The Terraform state configuration'
    required: true
  unlock:
    description: 'Unlock the state'
    required: false
    default: 'false'
  lock_id:
    description: 'The lock ID'
    required: false
    default: ''
  destroy:
    description: 'Destroy the state'
    required: false
    default: 'false'
  release_name:
    description: 'The release name'
    required: true
  release_version:
    description: 'The release version'
    required: true
  qualifier:
    description: 'The release qualifier'
    required: false
    default: ''
  project_key:
    description: 'The package name'
    required: true
  deployment_name:
    description: 'The deployment name'
    required: true
  environment:
    description: 'The environment'
    required: true
  artifacts_name:
    description: 'The name of the artifacts to save'
    required: false
    default: 'build_artifacts'
  front_end:
    description: 'The front end flag, used mainly for NodeJS targets'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
#    - name: IAC Setup
#      uses: cloudopsworks/blueprints/cd/deploy/common/iac@v5.10
#      with:
#        source_path: ${{ inputs.source_path }}
#        blueprint_path: ${{ inputs.blueprint_path }}
#        token: ${{ inputs.token }}

#    - name: Copy configurations
#      shell: bash
#      run: |
#        cp -pf ${{ inputs.source_path }}/.cloudopsworks/vars/inputs-${{ inputs.environment }}.yaml ${{ inputs.blueprint_path }}/devicefarms/aws/inputs.yaml
#        cp -pf ${{ inputs.source_path }}/.cloudopsworks/vars/inputs-global.yaml ${{ inputs.blueprint_path }}/devicefarms/aws/

    - name: Device Farm Name
      id: device_farm
      working-directory: ${{ inputs.source_path }}
      shell: bash
      run: |
        res=$(yq e '.aws.device_farm_name // ""' .cloudopsworks/vars/inputs-${{ inputs.environment }}.yaml)
        echo "result=$res" >> $GITHUB_OUTPUT

    - name: Test Script Path
      id: test_script_path
      working-directory: ${{ inputs.source_path }}
      shell: bash
      run: |
        res=$(yq e '.aws.test_script_path // "device_tests"' .cloudopsworks/vars/inputs-${{ inputs.environment }}.yaml)
        echo "result=$res" >> $GITHUB_OUTPUT

    - name: Tests Scripts Available
      id: test_script_available
      working-directory: ${{ inputs.source_path }}
      shell: bash
      run: |
        res=false
        # Check dir exists
        if [ -d ${{ steps.test_script_path.outputs.result }} ] ; then
          # Check dir has content
          if [ "$(ls -A ${{ steps.test_script_path.outputs.result }})" ] ; then
            res=true
          fi
        fi

    - name: Test Script Path
      id: test_script_type
      working-directory: ${{ inputs.source_path }}
      shell: bash
      run: |
        res=$(yq e '.aws.test_script_type // "APPIUM_PYTHON_TEST_PACKAGE"' .cloudopsworks/vars/inputs-${{ inputs.environment }}.yaml)
        echo "result=$res" >> $GITHUB_OUTPUT

    - name: Generate release.yaml
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws
      shell: bash
      run: |
        cat > release.yaml << EOF 
        release:
          name: ${{ inputs.release_name }}
          source:
            name: ${{ inputs.project_key }}
            version: ${{ inputs.release_version }}${{ inputs.front_end == 'true' && format('-{0}', inputs.environment) || '' }}
        EOF

    - name: Insert release.qualifier data into release.yaml
      if: ${{ inputs.qualifier != '' }}
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws
      shell: bash
      run: yq e -i '.release.qualifier = "${{ inputs.qualifier }}"' release.yaml

    - name: Generate Global Inputs global-inputs.yaml
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws
      shell: bash
      run: |
        cat > global-inputs.yaml << EOF
        environment: ${{ inputs.deployment_name }}${{ inputs.qualifier != '' && '/' || '' }}${{ inputs.qualifier }}
        release_name: ${{ inputs.release_name }}
        default:
          region: ${{ inputs.aws_region }}
          sts_role_arn: ${{ inputs.aws_sts_role_arn }}
        EOF

    - name: Determine Plan Action
      uses: actions/github-script@v8
      id: plan_action
      with:
        script: |
          const is_destroy = ${{ inputs.destroy }};
          const is_unlock = ${{ inputs.unlock }};
          if (is_destroy) {
            core.setOutput('value', 'plan -destroy -no-color -input=false')
            console.log('destroy');
          } else {
            if (is_unlock) {
              core.setOutput('value', 'force-unlock -force ${{ inputs.lock_id }}')
              console.log('unlock');
            } else {
              core.setOutput('value', 'plan -no-color -input=false')
              console.log('apply');
            }
          }

    #
    # Login AWS
    - name: Configure AWS Credentials
      if: ${{ inputs.aws_sts_role_arn == '' }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ inputs.aws_access_key_id }}
        aws-secret-access-key: ${{ inputs.aws_secret_access_key }}
        aws-region: ${{ inputs.aws_region }}

    #
    # Login AWS - w/Assume Role
    - name: Configure AWS Credentials with Assume Role
      if: ${{ inputs.aws_sts_role_arn != '' }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ inputs.aws_access_key_id }}
        aws-secret-access-key: ${{ inputs.aws_secret_access_key }}
        role-to-assume: ${{ inputs.aws_sts_role_arn }}
        role-session-name: ${{ github.repository_id }}-build
        aws-region: ${{ inputs.aws_region }}

    - name: Device Farm ARN
      id: device_farm_arn
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws
      shell: bash
      run: |
        res=$(aws devicefarm list-projects --region ${{ inputs.aws_region }} --query "projects[?name=='${{ steps.device_farm.outputs.result }}'].arn | [0]" --output text)

    - name: Restore Pipeline Artifacts
      uses: actions/download-artifact@v7
      if: ${{ inputs.artifacts_name != '' && inputs.unlock != 'true' && inputs.destroy != 'true' }}
      with:
        name: ${{ inputs.artifacts_name }}
        path: ${{ inputs.blueprint_path }}/devicefarms/aws/release

    - name: Zip test contents
      if: ${{ steps.test_script_available.outputs.result == 'true' }}
      working-directory: ${{ inputs.source_path }}/${{ steps.test_script_path.outputs.result }}
      shell: bash
      env:
        REL: ${{ inputs.release_name }}
        RELVER: ${{ inputs.release_version }}
        QUALI: ${{ inputs.qualifier != '' && '-' || '' }}${{ inputs.qualifier }}
      run: |
        zip -r ${{ inputs.blueprint_path }}/devicefarms/aws/release/${REL}-${RELVER}${QUALI}-tests.zip .

    - name: test
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws/release
      shell: bash
      run: ls -la

    - name: Rename IPA/APK
      id: ipa_apk
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws/release
      shell: bash
      env:
        REL: ${{ inputs.release_name }}
        RELVER: ${{ inputs.release_version }}
        QUALI: ${{ inputs.qualifier != '' && '-' || '' }}${{ inputs.qualifier }}
      run: |
        ext="${{ contains(fromJSON('["ios"]'), inputs.platform_type) && 'ipa' || 'apk' }}"
        app_type="{{ contains(fromJSON('["ios"]'), inputs.platform_type) && 'IOS_APP' || 'ANDROID_APP' }}"
        release=$(ls *.$ext 2>/dev/null)
        echo "Found: $release, moving to: ${REL}-${RELVER}${QUALI}.$ext" 
        mv $release ${REL}-${RELVER}${QUALI}.$ext
        echo "ext=$ext" >> $GITHUB_OUTPUT
        echo "app_type=$app_type" >> $GITHUB_OUTPUT

    - name: Upload IPA/APK
      id: upload_pkg
      if: ${{ ! cancelled() }}
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws/release
      shell: bash
      env:
        REL: ${{ inputs.release_name }}
        RELVER: ${{ inputs.release_version }}
        QUALI: ${{ inputs.qualifier != '' && '-' || '' }}${{ inputs.qualifier }}
        EXT: ${{ steps.ipa_apk.outputs.ext }}
        APP_TYPE: ${{ steps.ipa_apk.outputs.app_type }}
        GITHUB_API_TOKEN: ${{ inputs.token }}
      run: |
        echo "::group::Uplad APK"
        aws devicefarm create-upload --arn ${{ steps.device_farm_arn.outputs.result }} \
          --name "${REL}-${RELVER}${QUALI}.$EXT" \
          --type "APP_TYPE" \
          --content-type "application/octet-stream"
        echo "::endgroup::"

    - name: Deploy Test Package
      id: deploy_test_pkg
      if: ${{ steps.test_script_available.outputs.result == 'true' && ! cancelled() }}
      working-directory: ${{ inputs.blueprint_path }}/devicefarms/aws/release
      shell: bash
      env:
        REL: ${{ inputs.release_name }}
        RELVER: ${{ inputs.release_version }}
        QUALI: ${{ inputs.qualifier != '' && '-' || '' }}${{ inputs.qualifier }}
        GITHUB_API_TOKEN: ${{ inputs.token }}
      run: |
        echo "::group::Uplad Test Package"
        aws devicefarm create-upload --arn ${{ steps.device_farm_arn.outputs.result }} \
          --name "${REL}-${RELVER}${QUALI}-tests.zip" \
          --type "${{ steps.test_script_type.outputs.result }}" \
          --content-type "application/octet-stream"
        echo "::endgroup::"
